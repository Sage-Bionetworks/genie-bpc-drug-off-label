---
title: "Off-Label & Off-Guideline Project"
subtitle:  "Rough workspace for statistician"
author: "Alex Paynter"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  include = F,
  warning = F,
  message = F,
  fig.width = 7,
  fig.height = 5
)
```

```{r}
library(fs); library(purrr); library(here)
purrr::walk(.x = fs::dir_ls(here("R")), .f = source)
```

```{r}
dft_clin_dat_wide <- readr::read_rds(
  here('data', 'no_ca_seq_filter', 'clin_dat_wide.rds')
)

hreg_all <- dft_clin_dat_wide %>% select(hreg) %>% unnest(hreg)
```


### How often does 'lastadm' matter?

```{r}
dft_lastadm_impact <- hreg_all %>% 
  mutate(
    lastadm_any_diff = case_when(
      is.na(dx_reg_end_or_lastadm_any_int) & is.na(dx_reg_end_any_int) ~ F,
      is.na(dx_reg_end_or_lastadm_any_int)  ~ T,
      is.na(dx_reg_end_any_int) ~ T,
      abs(dx_reg_end_or_lastadm_any_int - dx_reg_end_any_int) > 0.5 ~ T,
      T ~ F
    ),
    lastadm_all_diff = case_when(
      is.na(dx_reg_end_or_lastadm_all_int) & is.na(dx_reg_end_all_int) ~ F,
      is.na(dx_reg_end_or_lastadm_all_int)  ~ T,
      is.na(dx_reg_end_all_int) ~ T,
      abs(dx_reg_end_or_lastadm_all_int - dx_reg_end_all_int) > 0.5 ~ T,
      T ~ F
    ),
    invest_reg = str_detect(regimen_drugs, "Investigational")
  )
```


```{r, include = T}
tabyl(dft_lastadm_impact, lastadm_any_diff)
tabyl(dft_lastadm_impact, lastadm_all_diff) # exactly the same.
```

The T/F indicator below is for the number which have or don't have an investigational drug in the regimen:

```{r, include = T}
tabyl(dft_lastadm_impact, lastadm_any_diff, invest_reg)
```


```{r, include = F, eval = F}
# probably better with View(.) than printed.
dft_lastadm_impact %>%
  filter(lastadm_any_diff) %>%
  select(regimen_drugs, contains('end')) %>%
  View(.)
```







```{r, eval = T}
hreg_all %<>%
  group_by(cohort, record_id, ca_seq) %>%
  mutate(
    reg_overlaps_with_any = any_time_overlaps(
      t_start = dx_reg_start_int,
      t_end = dx_reg_end_or_lastadm_all_int
    )
  ) %>%
  ungroup(.)
```

### Overlapping regimens

Looking within each ca_seq, how common is it for regimens to overlap?

```{r, include = T}
tabyl(hreg_all, reg_overlaps_with_any)
```

By cohort:

```{r, include = T}
tabyl(hreg_all, reg_overlaps_with_any, cohort)
```

As expected, the cohorts which get lots of hormone therapy have lots of overlaps.

Regimens that commonly overlap:

```{r, include = T}
hreg_all %>%
  filter(reg_overlaps_with_any) %>%
  count(regimen_drugs, sort = T) %>%
  head(.)
```

Not that illuminating, just tells us that prostate and breast cancer again account for most of the work.


