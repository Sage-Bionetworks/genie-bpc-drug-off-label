---
title: "Off-Label & Off-Guideline Project"
author: "Alex Paynter"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  include = T,
  warning = F,
  message = F,
  fig.width = 7,
  fig.height = 5
)
```





```{r}
library(fs); library(purrr); library(here)
purrr::walk(.x = fs::dir_ls(here("R")), .f = source)
```

## Introduction

This is a working document for analyses related to the Off-label & Off-guideline manuscript chaired by Jeremy Warner.

Some important filtering of the raw BPC data we will apply:

- Only regimens associated with the first index cancer for each person will be analyzed.  
  - This also effectively handles a convention in the BPC data, which is to have two regimen lines if a regimen could potentially be associated with more than one cancer.
- For those with a non-index cancer, their index cancer must precede the non-index cancer to be included.  
  
**Definitions:**

- *index cancer* - The cancer diagnosis that qualified the participant for curation into a BPC cohort (e.g. to be in the prostate cohort you must have a prostate cancer in the list).
- *repeat regimens* - If a participant has a regimen with drugs {A,B,C} and the very next regimen in their record is {A,B,C} again, that second regimen is a repeat regimen.  If they use {A,B,C,D} or {A,B} in their next regimen that doesn't count (but we can look at that if needed).



```{r}
# For this first bit we need the raw data:
dft_raw_data <- load_all_raw_data_of_type('cancer_level_dataset_index')

dft_raw_data <- left_join(
  dft_raw_data,
  load_all_raw_data_of_type('cancer_level_dataset_non_index'),
  by = "cohort"
)

# Test case if you like:
# ca_ind_test <- dft_raw_data %>% slice(1) %>% pull(cancer_level_dataset_index) %>% `[[`(1)
# ca_non_ind_test <- dft_raw_data %>% slice(1) %>% pull(cancer_level_dataset_non_index) %>% `[[`(1)
# summarize_records_by_index(ca_ind_test, ca_non_ind_test)

dft_raw_data %<>%
  mutate(
    sum = purrr::map2(
      .x = cancer_level_dataset_index,
      .y = cancer_level_dataset_non_index,
      .f = (function(x, y) {
        summarize_records_by_index(
          dat_ind = x,
          dat_non_ind = y)
      })
    )
  )

dft_index <- dft_raw_data %>% select(sum) %>% unnest(sum)

# Note that we have some people with more than one row, but it's because they're in multiple cohorts:
# dft_index %>% count(record_id, sort = T)
# dft_index %>% filter(record_id %in% c('GENIE-DFCI-085643', 'GENIE-MSK-P-0002880'))

# Should be zero rows:
# dft_index %>%
#   filter(has_non_index_cancer & (ca_seq_of_first_non_index == ca_seq_of_first_index))
```


```{r}
dft_filtering_impact <- dft_index %>%
  group_by(cohort) %>%
  summarize(
    n = n(),
    non_index = sum(has_non_index_cancer, na.rm = T),
    non_index_before_index = sum(has_non_index_cancer & 
      (ca_seq_of_first_non_index < ca_seq_of_first_index), na.rm = T),
    our_cohort = n - non_index_before_index,
    mult_index = sum(multiple_index_cancers, na.rm = T),
    .groups = 'drop'
  ) 


dfp_filtering_impact <- dft_filtering_impact %>%
  mutate(
    across(
      .cols = c(non_index, non_index_before_index, our_cohort, mult_index),
      .fns = (function(a) n_pct_str(a, n))
    )
  ) %>%
  rename(
    `Number with any non-index cancer` = non_index,
    `Number with a non-index cancer before first index cancer` = non_index_before_index,
    `Our cohort` = our_cohort,
    `Number with greater than one index cancer` = mult_index
  ) # %>%
# select(-`Our cohort`) # leave open for now.
    
  
  # summarize(
  #   n = n(),
  #   `Number with any non-index cancer` = sum(has_non_index_cancer, na.rm = T),
  #   `Number with a non-index cancer before first index cancer` = sum(has_non_index_cancer & 
  #     (ca_seq_of_first_non_index < ca_seq_of_first_index), na.rm = T),
  #   `Number with greater than one index cancer` = sum(multiple_index_cancers, na.rm = T),
  #   
  # )

dfp_filtering_impact %<>%
  mutate(n = glue("{n}")) %>%
  pivot_longer(
    cols = -cohort,
  ) %>%
  pivot_wider(
    names_from = cohort,
    values_from = value
  ) %>%
  rename(` ` = name) 
```



## Content

### R1.1 Cohort filtering impact

As stated in the introduction, we filter our cohort to only the first index cancer case and also exclude those who have an non-index cancer before their first cancer diagnosis.  The following table assesses the impact of these filters.  Each entry describes the number of **participants** which meet the criterion.

```{r, include = T}
dfp_filtering_impact %>%
  huxtable(.) %>%
  theme_article(.)
```






```{r}
dft_all_reg <- load_all_data_of_type("reg")

# select each reg dataset to have only the columns we need for the time being:
dft_all_reg %<>%
  mutate(
    reg = purrr::map(
      .x = reg,
      .f = (function(d) {
        select(
          d, 
          record_id, ca_seq, regimen_number,
          regimen_drugs)
      })
    )
  ) %>%
  unnest(reg)

dft_reg_repeat <- dft_all_reg %>%
  group_by(cohort, record_id, ca_seq) %>%
  mutate(
    is_repeat = lag(regimen_drugs) == regimen_drugs,
    is_repeat = if_else(is.na(is_repeat), F, is_repeat),
    # A repeat pair is both the uses of the drug.
    repeat_pair = is_repeat | lead(is_repeat)
  ) %>%
    ungroup

# Most common repeat regimens by cohort:
dfp_reg_repeat_top_drugs <- dft_reg_repeat %>%
  filter(is_repeat) %>%
  count(cohort, regimen_drugs) %>%
  arrange(cohort, desc(n)) %>%
  group_by(cohort) %>% 
  slice(1:8) %>%
  ungroup(.) 

hux_reg_repeat_top <- dfp_reg_repeat_top_drugs %>% 
  huxtable(.)

hux_reg_top_list <- split_across(
  hux_reg_repeat_top, 
  dfp_reg_repeat_top_drugs$cohort != lag(dfp_reg_repeat_top_drugs$cohort, default = "BLADDER")
)
```

### R1.3 Most frequently repeated regimens in each cohort

See front matter for the definition of a repeat regimen.  The following tables show the regimens most frequently repeated in each cohort.  These are raw counts, so it's possible that one person can have more than one repeat.  "Investigational drug" entries are left in for now, but can be easily removed in later analyses.

```{r print_top_reg_lists, include = T, results = 'asis'}
# print_html(hux_reg_top_list[[1]])
purrr::walk(
  .x = hux_reg_top_list, 
  .f = (function(k) {
    k %>%
      theme_article(.) %>%
      set_position(., value = "left") %>%
      print_html(.)
  })
)
```

```{r}
# Todo:  Percentage of participants with >1 repeat regimen.
# Percentage of regimens which are repeats.
# Split by cohort as always.




# Some ways to display this

# dft_reg_repeat %>% filter(is_repeat)
# 
# dft_all_reg %>% slice(1) %>% pull(reg) %>% glimpse
```
