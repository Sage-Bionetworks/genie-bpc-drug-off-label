---
title: "Off-Label & Off-Guideline Project"
author: "Alex Paynter"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  include = F,
  warning = F,
  message = F,
  fig.width = 7,
  fig.height = 5
)
```





```{r}
library(fs); library(purrr); library(here)
purrr::walk(.x = fs::dir_ls(here("R")), .f = source)
```

```{r}
gdtools::register_gfont('Roboto')
set_flextable_defaults(
  font.size = 10,
  theme_fun = theme_booktabs,
  font.family = 'Roboto'
)


```


## Introduction

This is a working document for analyses related to the Off-label & Off-guideline manuscript chaired by Jeremy Warner.

The regimen/drug data is filtered in all tables to **exclude Investigational Drugs**.

Some important filtering of the raw BPC data we will apply to all items except for R1.1:

- Only participants with a **single** cancer diagnosis are included ("first and only" cancers in GENIE BPC).
  
**Definitions:**

- *index cancer* - The cancer diagnosis that qualified the participant for curation into a BPC cohort (e.g. to be in the prostate cohort you must have a prostate cancer matching a set of Oncotree codes).
- *F&O* - First and only cancer diagnosis.  Meaning that the only known cancer for this participant was the one that qualitified them for inclusion in a GENIE BPC cohort.
- *repeat regimens* - If a participant has a regimen with drugs {A,B,C} and the very next regimen in their record is {A,B,C} again, that second regimen is a repeat regimen.  If they use {A,B,C,D} or {A,B} in their next regimen that doesn't count.



```{r}
dft_all_cases <- readr::read_rds(
  here('data', 'no_ca_seq_filter', 'clin_dat_wide.rds')
)

dft_cohort_cases <- readr::read_rds(
  here('data', 'cohort', 'clin_dat_wide.rds')
)

dft_filtering_impact <- bind_rows(
  mutate(summarize_cohort(dft_all_cases), filt = "Raw"),
  mutate(summarize_cohort(dft_cohort_cases), filt = "First & Only")
)

dfp_filtering_impact <- dft_filtering_impact %>%
  pivot_longer(
    cols = -c(cohort, filt),
    names_to = "quantity"
  )  %>%
  pivot_wider(
    names_from = "cohort",
    values_from = "value"
  ) %>%
  select(quantity, filt, everything()) 

dfp_filtering_impact %<>%
  mutate(quantity = forcats::fct_inorder(quantity)) %>%
  arrange(quantity, desc(filt))
```



## Content

### *R1.1 Cohort filtering impact

Now that we're filtering to F&O, we have some room to describe additional quanitites of our cohort filtering.  Four quantities are shown:

- `n_pts` - The number of unique patients.
- `n_cancers` - The number of cancers in those patients.  Note that this is the same for the First & Only cohort because each person has exactly one cancer.
- `n_reg` - The number of regimens, using the unaltered definition used in GENIE BPC.  This does not include invesigational 
- `n_unique_drug` - The number of unique drugs observed among all the regimens.

```{r, include = T}
dfp_filtering_impact %>%
  flextable(.) %>%
  flextable::merge_v(j = 'quantity') %>%
  flextable::fix_border_issues(.) %>%
  flextable::valign(j = 'quantity', valign = 'top') %>%
  flextable::bg(i = c(2,4,6,8), bg = '#e6ecf2')
```

From this point on the tables deal only with the *First & Only* cases.



```{r}
dfp_reg_sum <- dft_cohort_cases %>% 
  select(cohort, hreg) %>%
  mutate(hreg = purrr::map(
    .x = hreg,
    .f = \(x) select(x, -cohort)
  )) %>%
  unnest(hreg) %>%
  group_by(cohort, regimen_drugs) %>%
  summarize(
    n_regimens = n(),
    n_people = length(unique(record_id)),
    .groups = "drop"
  )
```


```{r, write_excel_data, include = F}
dfp_reg_sum %>%
  arrange(cohort, regimen_drugs) %>%
  readr::write_csv(
    x = .,
    file = here('output', 'regimen_counts_by_cohort.csv')
  )
```

### *R1.2 Regimen drugs

See the **attached CSV** (regimen_counts_by_cohort.csv) for the full list of regimens observed in each cohort.  Again, this does not include any regimens with investigational agents, and we have filtered each group to F&O cancers.

For convenience, the following table supports simple text searching (not case sensitive).  For example, if you type "Carboplatin bladder" you should see all summaries for the drug carboplatin in the bladder cohort.

Each row shows the number of regimens with those drugs we have in the data (`n_regimens`) and the number of people who had at least one regimen with those exact drugs (`n_people`).

```{r print_reg_table, show = T, include = T}
DT::datatable(dfp_reg_sum, options = list(DisplayLength = 25))
```


